name: MLflow CI/CD Pipeline

on:
  # Trigger saat push ke main atau saat ada perubahan di MLProject/
  push:
    branches:
      - main
    paths:
      - 'MLProject/**'
      - '.github/workflows/ci_workflow.yml'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      n_estimators:
        description: 'Number of estimators'
        required: false
        default: '100'
      max_depth:
        description: 'Max tree depth'
        required: false
        default: '6'
      learning_rate:
        description: 'Learning rate'
        required: false
        default: '0.1'

env:
  MLFLOW_TRACKING_URI: file:./mlruns
  DOCKER_IMAGE: daneeeee/toyota-mlflow-ci

jobs:
  # ============================================================================
  # JOB 1: TRAIN MODEL WITH MLFLOW PROJECT
  # ============================================================================
  train-model:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow pushing to repository
    
    # Tambahkan default shell untuk conda
    defaults:
      run:
        shell: bash -el {0}
    
    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Setup Conda (needed for MLflow Project)
      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: '3.12'
          miniconda-version: "latest"
          activate-environment: mlflow-env
          environment-file: MLProject/conda.yaml
      
      # Install MLflow di base environment
      - name: Install MLflow
        run: |
          pip install mlflow==3.6.0
          mlflow --version
      
      # Run MLflow Project
      - name: Run MLflow Project Training
        run: |
          echo " Starting MLflow Project Training..."
          cd MLProject
          
          # Set parameters
          N_EST=${{ github.event.inputs.n_estimators || '100' }}
          MAX_D=${{ github.event.inputs.max_depth || '6' }}
          LR=${{ github.event.inputs.learning_rate || '0.1' }}
          
          echo "Parameters:"
          echo "  n_estimators: $N_EST"
          echo "  max_depth: $MAX_D"
          echo "  learning_rate: $LR"
          
          # Run MLflow project dengan --no-conda jika sudah setup environment
          # Atau gunakan --env-manager=local untuk skip conda creation
          mlflow run . \
            --env-manager=local \
            -P n_estimators=$N_EST \
            -P max_depth=$MAX_D \
            -P learning_rate=$LR \
            -P test_size=0.2
          
          echo " Training completed!"
      
      # List generated artifacts
      - name: List MLflow artifacts
        run: |
          echo " MLflow artifacts:"
          ls -lah MLProject/mlruns/
          find MLProject/mlruns -type f -name "*.pkl" -o -name "*.json" -o -name "model" | head -20
      
      # Copy artifacts for upload
      - name: Prepare artifacts for upload
        run: |
          mkdir -p artifacts_output
          
          # Copy mlruns
          cp -r MLProject/mlruns artifacts_output/ || echo "No mlruns found"
          
          # Copy model artifacts if exist
          if [ -d "MLProject/mlruns" ]; then
            find MLProject/mlruns -name "model" -type d | while read model_dir; do
              cp -r "$model_dir" artifacts_output/ 2>/dev/null || true
            done
          fi
          
          # Create summary
          cat > artifacts_output/training_summary.txt << EOF
          Training Summary
          ================
          Date: $(date)
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Triggered by: ${{ github.event_name }}
          
          Parameters:
          - n_estimators: ${{ github.event.inputs.n_estimators || '100' }}
          - max_depth: ${{ github.event.inputs.max_depth || '6' }}
          - learning_rate: ${{ github.event.inputs.learning_rate || '0.1' }}
          EOF
          
          echo " Artifacts prepared"
          ls -lah artifacts_output/
      
      # Upload artifacts to GitHub
      - name: Upload MLflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-training-artifacts-${{ github.run_number }}
          path: artifacts_output/
          retention-days: 90
      
      # Commit artifacts back to repo (SKILLED requirement)
      - name: Commit artifacts to repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Pull latest changes first
          git pull origin main
          
          # Create artifacts directory if not exists
          mkdir -p saved_artifacts
          
          # Copy latest run artifacts
          if [ -d "artifacts_output/mlruns" ]; then
            cp -r artifacts_output/mlruns saved_artifacts/mlruns_$(date +%Y%m%d_%H%M%S)
          fi
          
          # Copy summary
          cp artifacts_output/training_summary.txt saved_artifacts/ || true
          
          # Add and commit
          git add saved_artifacts/ || true
          
          if git diff --staged --quiet; then
            echo " No changes to commit"
          else
            git commit -m "ðŸ¤– Auto: Save training artifacts from run #${{ github.run_number }} [skip ci]"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git main
            echo " Artifacts committed to repository"
          fi
      
      # Create job summary
      - name: Create job summary
        if: always()
        run: |
          echo "##  MLflow CI/CD Training Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "###  Training Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Parameters:**" >> $GITHUB_STEP_SUMMARY
          echo "- n_estimators: ${{ github.event.inputs.n_estimators || '100' }}" >> $GITHUB_STEP_SUMMARY
          echo "- max_depth: ${{ github.event.inputs.max_depth || '6' }}" >> $GITHUB_STEP_SUMMARY
          echo "- learning_rate: ${{ github.event.inputs.learning_rate || '0.1' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "-  Artifacts saved to GitHub (retention: 90 days)" >> $GITHUB_STEP_SUMMARY
          echo "-  Artifacts committed to repository" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Docker image will be built in the next job" >> $GITHUB_STEP_SUMMARY
  
  # ============================================================================
  # JOB 2: BUILD AND PUSH DOCKER IMAGE (ADVANCE requirement)
  # ============================================================================
  build-docker:
    runs-on: ubuntu-latest
    needs: train-model
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download training artifacts
        uses: actions/download-artifact@v4
        with:
          name: mlflow-training-artifacts-${{ github.run_number }}
          path: ./artifacts_downloaded
      
      - name: Restore MLflow artifacts
        run: |
          echo " Restoring MLflow artifacts..."
          
          # Copy mlruns to working directory
          if [ -d "artifacts_downloaded/mlruns" ]; then
            cp -r artifacts_downloaded/mlruns .
            echo "âœ“ mlruns restored"
          fi
          
          # Also copy to MLProject if needed
          if [ -d "MLProject" ]; then
            cp -r artifacts_downloaded/mlruns MLProject/ 2>/dev/null || true
          fi
          
          echo ""
          echo " Searching for trained model..."
          find . -name "MLmodel" -type f 2>/dev/null | head -5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install MLflow
        run: |
          pip install mlflow==3.6.0
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: daneeeee
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
      
      - name: Build Docker image with MLflow
        run: |
          MLMODEL_PATH=$(find . -name "MLmodel" -type f 2>/dev/null | head -1)
          
          if [ -z "$MLMODEL_PATH" ]; then
            echo " ERROR: No trained model found!"
            echo "Please ensure Job 1 (train-model) completed successfully."
            exit 1
          fi
          
          # Get model directory (parent of MLmodel file)
          MODEL_DIR=$(dirname "$MLMODEL_PATH")
          MODEL_ABS_PATH=$(cd "$MODEL_DIR" && pwd)
          
          echo " Found trained model:"
          echo "   Path: $MODEL_DIR"
          echo "   Absolute: $MODEL_ABS_PATH"
          echo ""
          
          # Show model contents
          echo " Model artifact contents:"
          ls -lh "$MODEL_ABS_PATH"
          echo ""
          
          # Verify required files
          if [ -f "$MODEL_ABS_PATH/MLmodel" ]; then
            echo "âœ“ MLmodel found"
          fi
          if [ -f "$MODEL_ABS_PATH/conda.yaml" ] || [ -f "$MODEL_ABS_PATH/requirements.txt" ]; then
            echo "âœ“ Dependencies file found"
          fi
          if [ -f "$MODEL_ABS_PATH/model.ubj" ] || [ -f "$MODEL_ABS_PATH/model.pkl" ]; then
            echo "âœ“ Model binary found"
          fi
          
          echo ""
          echo " Running mlflow models build-docker..."
          
          # Build Docker image with MLflow (NO manual Dockerfile needed!)
          mlflow models build-docker \
            --model-uri "$MODEL_ABS_PATH" \
            --name "${{ env.DOCKER_IMAGE }}:latest" \
            --enable-mlserver
          
          # Check build status
          if [ $? -eq 0 ]; then
            echo ""
            echo " Docker image built successfully with MLflow!"
            echo "   No manual Dockerfile was needed - MLflow generated it automatically"
          else
            echo ""
            echo " Build failed!"
            exit 1
          fi
          
          # Tag with run number
          docker tag ${{ env.DOCKER_IMAGE }}:latest ${{ env.DOCKER_IMAGE }}:run-${{ github.run_number }}
          
          # Show created images
          echo ""
          echo " Docker images created:"
          docker images | grep toyota-mlflow-ci
          
          echo ""

          echo " Build completed successfully!"
      
      - name: Push Docker image to Docker Hub
        run: |
          echo " Pushing Docker image to Docker Hub..."
          docker push ${{ env.DOCKER_IMAGE }}:latest
          docker push ${{ env.DOCKER_IMAGE }}:run-${{ github.run_number }}
          echo "Docker image pushed successfully"
      
      - name: Docker Hub link summary
        run: |
          echo "##  Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.DOCKER_IMAGE }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`run-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull command:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.DOCKER_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Hub:** https://hub.docker.com/r/daneeeee/toyota-mlflow-ci" >> $GITHUB_STEP_SUMMARY
  
  # ============================================================================
  # JOB 3: FINAL SUMMARY
  # ============================================================================
  summary:
    runs-on: ubuntu-latest
    needs: [train-model, build-docker]
    if: always()
    
    steps:
      - name: Final Pipeline Summary
        run: |
          echo "##  CI/CD Pipeline Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Jobs Status" >> $GITHUB_STEP_SUMMARY
          echo "- Train Model: ${{ needs.train-model.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Docker: ${{ needs.build-docker.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "###  Deliverables" >> $GITHUB_STEP_SUMMARY
          echo "1. Model trained with MLflow Project" >> $GITHUB_STEP_SUMMARY
          echo "2. Artifacts saved to GitHub Actions" >> $GITHUB_STEP_SUMMARY
          echo "3. Artifacts committed to repository" >> $GITHUB_STEP_SUMMARY
          echo "4.  Docker image built and pushed to Docker Hub" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "###  Kriteria 3 - ADVANCE (4 PTS)" >> $GITHUB_STEP_SUMMARY
          echo "- [x] MLflow Project setup" >> $GITHUB_STEP_SUMMARY
          echo "- [x] CI/CD Workflow" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Artifacts saved to repository" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Docker image published" >> $GITHUB_STEP_SUMMARY